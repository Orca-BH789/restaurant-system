using Microsoft.EntityFrameworkCore;
using Restaurant_Management.Data;
using Restaurant_Management.Models.DTO;
using Restaurant_Management.Models.DTO.AI;
using Restaurant_Management.Models.DTO.AI.RestaurantManagement.DTOs.AI;
using Restaurant_Management.Models.Entities;
using RestaurantManagement.Models;
using System.Text.Json;


namespace Restaurant_Management.Services.AI
{
    public class AIChatService : IAIChatService
    {
        private readonly RestaurantDbContext _context;
        private readonly IGeminiService _geminiService;
        private readonly IAIAnalyticsService _analyticsService;
        private readonly IAIQueryGeneratorService _queryGenerator;

        public AIChatService(
            RestaurantDbContext context,
            IGeminiService geminiService,
            IAIAnalyticsService analyticsService,
            IAIQueryGeneratorService queryGenerator)
        {
            _context = context;
            _geminiService = geminiService;
            _analyticsService = analyticsService;
            _queryGenerator = queryGenerator;
        }

        public async Task<SendMessageResponse> SendMessageAsync(SendMessageRequest request, int? userId = null)
        {
            // ✅ Detect intent TRƯỚC để tránh NULL
            var intent = DetectIntent(request.Message);

            // ✅ Đảm bảo luôn có SessionId
            var sessionId = string.IsNullOrEmpty(request.SessionId)
                ? Guid.NewGuid().ToString()
                : request.SessionId;

            // Get or create conversation
            AIChatConversation conversation;

            if (!string.IsNullOrEmpty(request.SessionId))
            {
                conversation = await _context.AIChatConversations
                    .Include(c => c.Messages)
                    .FirstOrDefaultAsync(c => c.SessionId == request.SessionId && c.IsActive);

                if (conversation == null)
                    throw new Exception("Conversation not found");

                // Update intent for existing conversation
                conversation.IntentType = intent;
            }
            else
            {
                conversation = new AIChatConversation
                {
                    UserId = userId,
                    SessionId = sessionId, // ✅ Luôn có giá trị
                    Topic = request.Message.Length > 50
                        ? request.Message.Substring(0, 50) + "..."
                        : request.Message,
                    IntentType = intent,
                    IsActive = true,
                    StartedAt = DateTime.UtcNow,
                    LastMessageAt = DateTime.UtcNow
                };
                await _context.AIChatConversations.AddAsync(conversation);
                await _context.SaveChangesAsync();
            }

            // Save user message
            await SaveMessageAsync(conversation.Id, "user", request.Message);

            // Build context for Gemini
            var context = await BuildContextAsync(userId, intent);

            // Get conversation history
            var history = conversation.Messages?
                .OrderBy(m => m.CreatedAt)
                .Select(m => new ChatMessageDto
                {
                    Role = m.Role,
                    Content = m.Content,
                    CreatedAt = m.CreatedAt
                })
                .ToList() ?? new List<ChatMessageDto>();

            // Call Gemini
            var aiResponse = await _geminiService.GetChatCompletionAsync(
                request.Message,
                history,
                context
            );

            // Save assistant response
            await SaveMessageAsync(conversation.Id, "assistant", aiResponse);

            // Update conversation
            conversation.LastMessageAt = DateTime.UtcNow;
            await _context.SaveChangesAsync();

            // Log action
            await LogActionAsync(conversation.Id, intent, aiResponse);

            return new SendMessageResponse
            {
                SessionId = conversation.SessionId,
                Response = aiResponse,
                IntentType = intent,
                Data = null,
                Timestamp = DateTime.UtcNow
            };
        }

        public async Task<List<MenuSuggestionDto>> SuggestMenuItemsAsync(string userMessage, int? userId, int conversationId)
        {
            // Base query
            var query = _context.MenuItems
                .Include(m => m.Category)
                .Where(m => m.IsAvailable && m.IsActive);

            // Get top 5 items with category
            var items = await query.Take(5).ToListAsync();

            var suggestions = items.Select(m => new MenuSuggestionDto
            {
                MenuItemId = m.Id,
                Name = m.Name,
                Description = m.Description,
                Price = m.Price,
                ImageUrl = m.ImageUrl,
                Reason = "Gợi ý được chọn dựa trên tính sẵn có",
                ConfidenceScore = 0.8
            }).ToList();

            // Log actions
            foreach (var suggestion in suggestions)
            {
                await _context.AddAsync(new AIChatActionLog
                {
                    ConversationId = conversationId,
                    ActionType = "suggest_item",
                    EntityType = "MenuItem",
                    EntityId = suggestion.MenuItemId,
                    ActionData = JsonSerializer.Serialize(new { reason = suggestion.Reason }),
                    CreatedAt = DateTime.UtcNow
                });
            }
            await _context.SaveChangesAsync();

            return suggestions;
        }

        public async Task<List<PromotionSuggestionDto>> SuggestPromotionsAsync(string userMessage, int conversationId)
        {
            // Get active promotions
            var promotions = await _context.Promotions
                .Where(p => p.Active
                         && p.StartDate <= DateTime.UtcNow
                         && p.EndDate >= DateTime.UtcNow)
                .ToListAsync();

            // Analyze usage from HistoryLog
            var promotionUsage = await _context.HistoryLogs
                .Where(h => h.Entity == "Order"
                         && h.Action == "Create"
                         && h.CreatedAt >= DateTime.UtcNow.AddMonths(-1))
                .ToListAsync();

            var usageStats = promotionUsage
                .Select(h => JsonSerializer.Deserialize<Dictionary<string, object>>(h.NewData))
                .Where(data => data.ContainsKey("PromotionId") && data["PromotionId"] != null)
                .GroupBy(data => Convert.ToInt32(data["PromotionId"]))
                .ToDictionary(g => g.Key, g => g.Count());

            var suggestions = promotions.Select(p => new PromotionSuggestionDto
            {
                PromotionId = p.Id,
                Code = p.Code,
                Description = p.Description,
                DiscountValue = p.DiscountAmount ?? p.DiscountPercent ?? 0,
                DiscountType = p.DiscountAmount.HasValue ? "Amount" : "Percentage",
                Reason = usageStats.ContainsKey(p.Id)
                    ? $"Được sử dụng {usageStats[p.Id]} lần trong tháng qua"
                    : "Khuyến mãi mới",
                UsageCount = usageStats.ContainsKey(p.Id) ? usageStats[p.Id] : 0
            })
            .OrderByDescending(p => p.UsageCount)
            .Take(3)
            .ToList();

            // Log actions
            foreach (var suggestion in suggestions)
            {
                await _context.AddAsync(new AIChatActionLog
                {
                    ConversationId = conversationId,
                    ActionType = "suggest_promotion",
                    EntityType = "Promotion",
                    EntityId = suggestion.PromotionId,
                    ActionData = JsonSerializer.Serialize(new { usageCount = suggestion.UsageCount }),
                    CreatedAt = DateTime.UtcNow
                });
            }
            await _context.SaveChangesAsync();

            return suggestions;
        }

        public async Task<ReservationSuggestionDto> SuggestReservationAsync(string userMessage, int conversationId)
        {
            var requestedDate = DateTime.Today.AddDays(1);
            var requestedTime = new TimeSpan(19, 0, 0);
            var partySize = 2;

            var requestedDateTime = requestedDate.Add(requestedTime);

            // Find available tables
            var bookedTableIds = await _context.ReservationTables
                .Include(rt => rt.Reservation)
                .Where(rt => rt.Reservation.ReservationTime.Date == requestedDate.Date
                         && rt.Reservation.Status != "Cancelled")
                .Select(rt => rt.TableId)
                .ToListAsync();

            var availableTables = await _context.Tables
                .Where(t => t.Capacity >= partySize
                         && t.IsActive
                         && !bookedTableIds.Contains(t.Id))
                .Select(t => t.Id)
                .ToListAsync();

            var suggestion = new ReservationSuggestionDto
            {
                AvailableTableIds = availableTables,
                SuggestedTime = requestedDateTime,
                Reason = availableTables.Any()
                    ? $"Có {availableTables.Count} bàn trống phù hợp"
                    : "Không có bàn trống, vui lòng chọn thời gian khác"
            };

            // Log action
            await _context.AddAsync(new AIChatActionLog
            {
                ConversationId = conversationId,
                ActionType = "suggest_reservation",
                EntityType = "Reservation",
                ActionData = JsonSerializer.Serialize(new
                {
                    requestedDate,
                    requestedTime = requestedTime.ToString(),
                    partySize,
                    availableCount = availableTables.Count
                }),
                Result = JsonSerializer.Serialize(suggestion),
                CreatedAt = DateTime.UtcNow
            });
            await _context.SaveChangesAsync();

            return suggestion;
        }

        public async Task<AnalyticsResultDto> QueryAnalyticsAsync(string userMessage, int conversationId, int userId)
        {
            // Check if user has permission (admin/manager)
            var user = await _context.Users.FindAsync(userId);
            if (user?.Role != User.UserRole.Admin && user?.Role != User.UserRole.Manager)
            {
                throw new UnauthorizedAccessException("Chỉ quản lý mới được xem thống kê");
            }

            var period = "today";
            var (startDate, endDate) = GetDateRange(period);
            var result = await _analyticsService.GetRevenueAnalysisAsync(startDate, endDate);

            // Log action
            await _context.AddAsync(new AIChatActionLog
            {
                ConversationId = conversationId,
                ActionType = "query_analytics",
                ActionData = JsonSerializer.Serialize(new { period }),
                Result = JsonSerializer.Serialize(new { summary = result.Summary }),
                CreatedAt = DateTime.UtcNow
            });
            await _context.SaveChangesAsync();

            return result;
        }

        public async Task<ConversationDto> GetConversationAsync(string sessionId)
        {
            var conversation = await _context.AIChatConversations
                .Include(c => c.Messages)
                .FirstOrDefaultAsync(c => c.SessionId == sessionId);

            if (conversation == null)
                return null;

            return new ConversationDto
            {
                Id = conversation.Id,
                SessionId = conversation.SessionId,
                Topic = conversation.Topic,
                IsActive = conversation.IsActive,
                StartedAt = conversation.StartedAt,
                LastMessageAt = conversation.LastMessageAt,
                Messages = conversation.Messages
                    .OrderBy(m => m.CreatedAt)
                    .Select(m => new ChatMessageDto
                    {
                        Role = m.Role,
                        Content = m.Content,
                        CreatedAt = m.CreatedAt,
                        Metadata = string.IsNullOrEmpty(m.Metadata)
                            ? null
                            : JsonSerializer.Deserialize<object>(m.Metadata)
                    })
                    .ToList()
            };
        }

        public async Task<ConversationHistoryResponse> GetUserConversationsAsync(
           int? userId, int page = 1, int pageSize = 10)
        {
            var query = _context.AIChatConversations.AsQueryable();

            if (userId.HasValue)
                query = query.Where(c => c.UserId == userId);
            else
                query = query.Where(c => c.UserId == null);

            var totalCount = await query.CountAsync();

            var conversations = await query
                .OrderByDescending(c => c.LastMessageAt)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .Include(c => c.Messages)
                .ToListAsync();

            return new ConversationHistoryResponse
            {
                Conversations = conversations.Select(c => new ConversationDto
                {
                    Id = c.Id,
                    SessionId = c.SessionId,
                    Topic = c.Topic,
                    IsActive = c.IsActive,
                    StartedAt = c.StartedAt,
                    LastMessageAt = c.LastMessageAt,
                    Messages = c.Messages
                        .OrderBy(m => m.CreatedAt)
                        .Select(m => new ChatMessageDto
                        {
                            Role = m.Role,
                            Content = m.Content,
                            CreatedAt = m.CreatedAt
                        })
                        .ToList()
                }).ToList(),
                TotalCount = totalCount
            };
        }

        public async Task<bool> EndConversationAsync(string sessionId)
        {
            var conversation = await _context.AIChatConversations
                .FirstOrDefaultAsync(c => c.SessionId == sessionId);

            if (conversation == null)
                return false;

            conversation.IsActive = false;
            await _context.SaveChangesAsync();
            return true;
        }

        // Helper methods
        private async Task SaveMessageAsync(int conversationId, string role, string content, object metadata = null)
        {
            var message = new AIChatMessage
            {
                ConversationId = conversationId,
                Role = role,
                Content = content,
                Metadata = metadata != null ? JsonSerializer.Serialize(metadata) : "{}", // ✅ Default: empty JSON
                CreatedAt = DateTime.UtcNow
            };

            await _context.AIChatMessages.AddAsync(message);
            await _context.SaveChangesAsync();
        }

        private string DetectIntent(string message)
        {
            message = message.ToLower();

            if (message.Contains("món") || message.Contains("ăn") || message.Contains("menu")
                || message.Contains("gợi ý") || message.Contains("recommend"))
                return "menu_suggestion";

            if (message.Contains("khuyến mãi") || message.Contains("promotion")
                || message.Contains("giảm giá") || message.Contains("combo"))
                return "promotion_suggestion";

            if (message.Contains("đặt bàn") || message.Contains("book") || message.Contains("reservation"))
                return "reservation";

            if (message.Contains("doanh thu") || message.Contains("thống kê")
                || message.Contains("báo cáo") || message.Contains("analytics"))
                return "analytics";

            return "general";
        }

        private async Task<AIContextDto> BuildContextAsync(int? userId, string intent)
        {
            var context = new AIContextDto();

            // Get available menu items
            var menuItems = await _context.MenuItems
                .Include(m => m.Category)
                .Where(m => m.IsAvailable && m.IsActive)
                .Take(20)
                .ToListAsync();

            context.AvailableMenuItems = menuItems.Select(m => new MenuItemForAIDto
            {
                Id = m.Id,
                Name = m.Name,
                Price = m.Price,
                Description = m.Description,
                CategoryName = m.Category?.Name ?? "Khác",
                IsVegetarian = false
            }).ToList();

            // Get active promotions
            var now = DateTime.UtcNow;
            var promotions = await _context.Promotions
                .Where(p => p.Active
                         && p.StartDate <= now
                         && p.EndDate >= now)
                .Take(10)
                .ToListAsync();

            context.ActivePromotions = promotions.Select(p => new PromotionForAIDto
            {
                Id = p.Id,
                Code = p.Code,
                Description = p.Description,
                DiscountValue = p.DiscountAmount ?? p.DiscountPercent ?? 0,
                DiscountType = p.DiscountAmount.HasValue ? "Amount" : "Percentage",
                StartDate = p.StartDate,
                EndDate = p.EndDate
            }).ToList();

            // Get available tables
            var tables = await _context.Tables
                .Where(t => t.IsActive && t.Status == "Available")
                .Take(15)
                .ToListAsync();

            context.AvailableTables = tables.Select(t => new TableForAIDto
            {
                Id = t.Id,
                TableNumber = t.TableNumber,
                TableName = t.TableName,
                Capacity = t.Capacity,
                Location = t.Location
            }).ToList();

            // ✅ LUÔN lấy analytics nếu có intent là "analytics"
            if (intent == "analytics")
            {
                try
                {
                    var (startDate, endDate) = GetDateRange("today");
                    var analytics = await _analyticsService.GetRevenueAnalysisAsync(startDate, endDate);
                    context.RecentAnalytics = analytics;
                }
                catch (Exception ex)
                {
                    context.RecentAnalytics = new AnalyticsResultDto
                    {
                        Summary = $"Không thể lấy dữ liệu analytics: {ex.Message}",
                        Data = null
                    };
                }
            }
            // ✅ Nếu là user Admin/Manager, thêm analytics context
            else if (userId.HasValue)
            {
                var user = await _context.Users.FindAsync(userId.Value);
                if (user?.Role == User.UserRole.Admin || user?.Role == User.UserRole.Manager)
                {
                    try
                    {
                        var (startDate, endDate) = GetDateRange("today");
                        var analytics = await _analyticsService.GetRevenueAnalysisAsync(startDate, endDate);
                        context.RecentAnalytics = analytics;
                    }
                    catch { }
                }
            }

            // Get user preferences if logged in
            if (userId.HasValue)
            {
                context.UserPreferences = await GetUserPreferencesAsync(userId.Value);
            }

            return context;
        }

        private string DetermineReason(MenuItem item, Dictionary<string, object> entities, int? userId)
        {
            var reasons = new List<string>();

            // Check if dietary filter was applied
            if (entities.ContainsKey("dietary") && entities["dietary"].ToString() == "vegetarian")
                reasons.Add("Phù hợp khẩu vị chay");

            if (entities.ContainsKey("budget"))
                reasons.Add("Trong ngân sách");

            if (userId.HasValue)
                reasons.Add("Dựa trên sở thích của bạn");

            return reasons.Any() ? string.Join(", ", reasons) : "Món phổ biến";
        }

        private string GenerateMenuResponse(List<MenuSuggestionDto> suggestions)
        {
            if (!suggestions.Any())
                return "Xin lỗi, tôi không tìm thấy món phù hợp. Bạn có thể thử tiêu chí khác không?";

            var response = "Dựa trên yêu cầu của bạn, tôi gợi ý:\n\n";
            foreach (var item in suggestions)
            {
                response += $"🍽️ **{item.Name}** - {item.Price:N0} VNĐ\n";
                response += $"   {item.Description}\n";
                response += $"   _{item.Reason}_\n\n";
            }

            return response;
        }

        private string GeneratePromotionResponse(List<PromotionSuggestionDto> suggestions)
        {
            if (!suggestions.Any())
                return "Hiện tại không có khuyến mãi phù hợp.";

            var response = "Các khuyến mãi đang áp dụng:\n\n";
            foreach (var promo in suggestions)
            {
                response += $"🎁 **{promo.Code}**\n";
                response += $"   {promo.Description}\n";
                var discountDisplay = promo.DiscountType == "Percentage"
                    ? $"{promo.DiscountValue}%"
                    : $"{promo.DiscountValue:N0} VNĐ";
                response += $"   Giảm: {discountDisplay}\n";
                response += $"   _{promo.Reason}_\n\n";
            }

            return response;
        }

        private async Task<Dictionary<string, object>> GetUserPreferencesAsync(int userId)
        {
            var preferences = new Dictionary<string, object>();

            var orderHistory = await _context.HistoryLogs
                .Where(h => h.Entity == "OrderItem"
                         && h.UserId == userId
                         && h.CreatedAt >= DateTime.UtcNow.AddMonths(-3))
                .ToListAsync();

            if (orderHistory.Any())
            {
                var items = orderHistory
                    .Select(h => JsonSerializer.Deserialize<Dictionary<string, object>>(h.NewData))
                    .ToList();

                var categoryGroups = items
                    .Where(i => i.ContainsKey("CategoryId"))
                    .GroupBy(i => i["CategoryId"])
                    .OrderByDescending(g => g.Count())
                    .FirstOrDefault();

                if (categoryGroups != null)
                {
                    preferences["preferredCategory"] = categoryGroups.Key;
                    preferences["orderCount"] = categoryGroups.Count();
                }

                var vegetarianCount = items.Count(i =>
                    i.ContainsKey("IsVegetarian") && Convert.ToBoolean(i["IsVegetarian"]));

                if (vegetarianCount > orderHistory.Count / 2)
                    preferences["dietary"] = "vegetarian";
            }

            return preferences;
        }

        private async Task LogActionAsync(int conversationId, string intent, string response)
        {
            await _context.AIChatActionLogs.AddAsync(new AIChatActionLog
            {
                ConversationId = conversationId,
                ActionType = intent,
                Result = response.Length > 500 ? response.Substring(0, 500) : response,
                CreatedAt = DateTime.UtcNow
            });
            await _context.SaveChangesAsync();
        }

        private string GenerateReservationResponse(ReservationSuggestionDto suggestion, Dictionary<string, object> entities)
        {
            if (!suggestion.AvailableTableIds.Any())
                return "Rất tiếc, không có bàn trống vào thời gian bạn yêu cầu. Bạn có thể chọn thời gian khác không?";

            var partySize = entities.ContainsKey("partySize") ? entities["partySize"] : 2;
            return $"Tuyệt vời! Có {suggestion.AvailableTableIds.Count} bàn trống cho {partySize} người vào {suggestion.SuggestedTime:dd/MM/yyyy HH:mm}.\n\n" +
                   $"Bạn có muốn tôi đặt bàn ngay không?";
        }

        private (DateTime startDate, DateTime endDate) GetDateRange(string period)
        {
            return period switch
            {
                "today" => (DateTime.Today, DateTime.Today.AddDays(1)),
                "week" => (DateTime.Today.AddDays(-7), DateTime.Today.AddDays(1)),
                "month" => (DateTime.Today.AddMonths(-1), DateTime.Today.AddDays(1)),
                _ => (DateTime.Today, DateTime.Today.AddDays(1))
            };
        }
    }
}